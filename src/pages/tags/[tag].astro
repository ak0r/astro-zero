---
import type { GetStaticPaths } from 'astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Container from '@/components/layout/Container.astro';
import PageHeader from '@/components/layout/PageHeader.astro';
import FilterTabs from '@/components/layout/FilterTabs.astro';
import { getAllPosts, getPostsByTag, sortPostsByDate, getCategoryCounts } from '@/utils/getContent';
import { getEntriesByYearSorted } from '@/utils/entries';
import { POST_CATEGORIES, siteConfig } from '@/site.config';
import { generateIndexSEO } from '@/utils/seo';
import SEO from '@/components/common/SEO.astro';
import YearGroup from '@/components/content/YearGroup.astro';

export const getStaticPaths = (async () => {
  const allPosts = await getAllPosts();
  
  // Get all unique tags from all posts
  const allTags = new Set<string>();
  allPosts.forEach(post => {
    post.data.tags?.forEach(tag => allTags.add(tag));
  });
  
  return Array.from(allTags).map(tag => ({
    params: { tag },
  }));
}) satisfies GetStaticPaths;

const { tag } = Astro.params;

// Fetch all posts with this tag
const allPosts = await getAllPosts();
const taggedPosts = getPostsByTag(allPosts, tag);
const sortedPosts = sortPostsByDate(taggedPosts);

// Group by year
const groupedPosts = getEntriesByYearSorted(sortedPosts);

// Get category counts for this tag
const tagCategoryCounts = taggedPosts.reduce((acc, post) => {
  const cat = post.data.category;
  acc[cat] = (acc[cat] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

// Build filter tabs
const tabs = [
  {
    label: 'All',
    href: '/tags',
    icon: 'tags',
  },
  ...POST_CATEGORIES.map(cat => ({
    label: siteConfig.categories[cat].title,
    href: `/tags/${tag}`,
    icon: siteConfig.categories[cat].icon,
    count: tagCategoryCounts[cat] || 0,
  })),
];

// Count posts by category for display
const categoryCounts = POST_CATEGORIES.map(cat => ({
  category: cat,
  count: tagCategoryCounts[cat] || 0,
})).filter(c => c.count > 0);

const totalCount = sortedPosts.length;

const seoData = generateIndexSEO('tags', Astro.url.href, { tag });
---

<BaseLayout>
  <SEO data={seoData} slot="seo" />
  <Container class="py-4 sm:py-8">
    
    <PageHeader
      title={`Tagged "${tag}"`}
      description={`${totalCount} ${totalCount === 1 ? 'post' : 'posts'} with this tag`}
      breadcrumb={Astro.url.pathname}
    />
    
    <!-- Back to all tags -->
    <div class="mb-8">
      <a href="/tags" class="internal-link not-prose link text-sm">
        ‚Üê Back to all tags
      </a>
    </div>
    
    <!-- Filter Tabs -->
    <FilterTabs tabs={tabs} class="mb-8" />
    
    <!-- Content by Year -->
    <div class="flex flex-col gap-16">
      {groupedPosts.map(([year, posts]) => (
        <YearGroup 
          year={parseInt(year)} 
          entries={posts}
          showCategory={true}
        />
      ))}
    </div>
  </Container>
  
  <!-- Client-side filtering -->
  <script>
    import { POST_CATEGORIES } from '@/site.config';
    
    function setupContentFiltering() {
      const filterButtons = document.querySelectorAll('.filter-tabs a');
      const contentItems = document.querySelectorAll('.content-entry');
      
      filterButtons.forEach((button, index) => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Update active state
          filterButtons.forEach(btn => {
            btn.classList.remove('bg-surface-2', 'text-content');
            btn.classList.add('text-content-3');
          });
          button.classList.remove('text-content-3');
          button.classList.add('bg-surface-2', 'text-content');
          
          // Determine filter: 'all' or category name
          const filter = index === 0 ? 'all' : POST_CATEGORIES[index - 1];
          
          // Filter content
          contentItems.forEach(item => {
            const category = item.getAttribute('data-category');
            
            if (filter === 'all' || category === filter) {
              item.style.display = '';
            } else {
              item.style.display = 'none';
            }
          });
          
          // Hide empty year groups
          document.querySelectorAll('.year-group').forEach(yearGroup => {
            const visibleItems = yearGroup.querySelectorAll('.content-entry:not([style*="display: none"])');
            yearGroup.style.display = visibleItems.length > 0 ? '' : 'none';
          });
        });
      });
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupContentFiltering);
    } else {
      setupContentFiltering();
    }
    
    document.addEventListener('astro:page-load', setupContentFiltering);
  </script>
</BaseLayout>