---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Container from '@/components/layout/Container.astro';
import PageHeader from '@/components/layout/PageHeader.astro';
import FilterTabs from '@/components/layout/FilterTabs.astro';
import { getAllPosts, getCategoryCounts } from '@/utils/getContent';
import { POST_CATEGORIES, siteConfig } from '@/site.config';
import { generateIndexSEO } from '@/utils/seo';
import SEO from '@/components/common/SEO.astro';

// Fetch all posts (includes galleries, travel, tech)
const allPosts = await getAllPosts();
const counts = getCategoryCounts(allPosts);

// Build comprehensive tag list with metadata
const tagMap = new Map();

// Process all posts (includes all categories)
allPosts.forEach(post => {
  post.data.tags?.forEach(tag => {
    if (!tagMap.has(tag)) {
      tagMap.set(tag, { name: tag, categories: new Set(), count: 0 });
    }
    const tagData = tagMap.get(tag);
    tagData.categories.add(post.data.category);
    tagData.count++;
  });
});

// Convert to array and sort by count
const allTags = Array.from(tagMap.values())
  .map(tag => ({
    name: tag.name,
    categories: Array.from(tag.categories),
    count: tag.count,
  }))
  .sort((a, b) => b.count - a.count);

// Build filter tabs from category config
const tabs = [
  {
    label: 'All',
    href: '/tags',
    icon: 'tags',
    count: allTags.length,
  },
  ...POST_CATEGORIES.map(cat => ({
    label: siteConfig.categories[cat].title,
    href: '/tags',
    icon: siteConfig.categories[cat].icon,
    count: counts[cat] || 0,
  })),
];

const seoData = generateIndexSEO('tags', Astro.url.href);
---

<BaseLayout>
  <SEO data={seoData} slot="seo" />
  <Container class="py-4 sm:py-8">
    <PageHeader
      title="Tags"
      description="Browse all content by topic"
      breadcrumb={Astro.url.pathname}
    />
    
    <!-- Filter Tabs -->
    <FilterTabs tabs={tabs} class="mb-12" />
    
    <!-- Tag Summary -->
    <div class="mb-8 text-sm text-content-3">
      {allTags.length} {allTags.length === 1 ? 'tag' : 'tags'} total
    </div>
    
    <!-- Tag Cloud -->
    <div class="flex flex-wrap gap-3" data-tag-container>
      {allTags.map(tag => (
        <a 
          href={`/tags/${tag.name}`}
          class="tag-item badge-ghost inline-flex items-center gap-2 transition-all hover:scale-105"
          data-categories={tag.categories.join(',')}
        >
          <span class="font-medium">{tag.name}</span>
          <span class="text-xs text-content-4 font-mono">
            {tag.count}
          </span>
        </a>
      ))}
    </div>
  </Container>
  
  <!-- Client-side filtering -->
  <script>
    import { POST_CATEGORIES } from '@/site.config';
    
    function setupTagFiltering() {
      const filterButtons = document.querySelectorAll('.filter-tabs a');
      const tagItems = document.querySelectorAll('.tag-item');
      
      filterButtons.forEach((button, index) => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Update active state
          filterButtons.forEach(btn => {
            btn.classList.remove('bg-surface-2', 'text-content');
            btn.classList.add('text-content-3');
          });
          button.classList.remove('text-content-3');
          button.classList.add('bg-surface-2', 'text-content');
          
          // Determine filter: 'all' or category name
          const filter = index === 0 ? 'all' : POST_CATEGORIES[index - 1];
          
          // Filter tags
          tagItems.forEach(item => {
            const categories = item.getAttribute('data-categories')?.split(',') || [];
            
            if (filter === 'all' || categories.includes(filter)) {
              item.style.display = '';
            } else {
              item.style.display = 'none';
            }
          });
        });
      });
    }
    
    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupTagFiltering);
    } else {
      setupTagFiltering();
    }
    
    // Re-initialize after Astro navigation
    document.addEventListener('astro:page-load', setupTagFiltering);
  </script>
</BaseLayout>