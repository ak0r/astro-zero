---
import { getAllGalleries, getGalleryImages, extractGalleryDir } from '@/utils/getGallery';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Container from '@/components/layout/Container.astro';
import { generateGallerySEO } from '@/utils/seo';
import SEO from '@/components/common/SEO.astro';
import { resolveImage, resolveImageFromPath } from '@/utils/images';
import ImageWrapper from '@/components/common/ImageWrapper.astro';
import Lightbox from '@/components/common/Lightbox.astro';
import Breadcrumbs from '@/components/widgets/Breadcrumbs.astro';
import { getBreadcrumbsFromPath } from '@/utils/commonFunctions';
import PageHeader from '@/components/layout/PageHeader.astro';

export const getStaticPaths = (async () => {
  const galleries = await getAllGalleries();
  
  return galleries.map((gallery) => ({
    params: { slug: gallery.data.slug || gallery.id },
    props: { gallery },
  }));
}) satisfies GetStaticPaths;

const { gallery } = Astro.props;
const { title, description, date, tags } = gallery.data;

const galleryDir = extractGalleryDir(gallery.filePath);

// Get all images for this gallery
const images = await getGalleryImages(galleryDir, gallery.data.imageDir);

const resolvedImages = await Promise.all(
  images.map(async (img) => {
    const resolved = await resolveImageFromPath(img.path);
    return {
      ...img.image,
      resolved,
    };
  })
);

// SEO data
const seoData = generateGallerySEO(gallery, Astro.url.href);

// Generate breadcrumbs for the page
const breadcrumbs = getBreadcrumbsFromPath(Astro.url.pathname);
---

<BaseLayout>
  <SEO data={seoData} slot="head" />
  
  <Container class="py-4 sm:py-8">
    <PageHeader
      title={title}
      description={description}
      breadcrumb={Astro.url.pathname}
    />

    <!-- Header -->
    <div class="animate mb-8">
      <meta data-pagefind-filter="collection[content]" content="gallery" />
      <meta data-pagefind-meta="title[content]" content={title} />
      <meta data-pagefind-sort="date[content]" content={date.toISOString()} />
      
      <!-- Metadata -->
      <div class="flex flex-wrap items-center gap-4 text-sm text-content-3">
        <span>{images.length} {images.length === 1 ? 'image' : 'images'}</span>
        
        {tags && tags.length > 0 && (
          <div class="flex flex-wrap gap-2 not-prose">
            {tags.map((tag) => (
              <a 
                href={`/gallery/tag/${tag}`}
                class="badge"
              >
                #{tag}
              </a>
            ))}
          </div>
        )}
      </div>
    </div>
    
    {resolvedImages.length > 0 ? (
      <div class="animate non-prose image-grid grid grid-cols-2 md:grid-cols-3 gap-4">
        {resolvedImages.map((img, index) => (
          <button
            type="button"
            class="gallery-image-button img-container group relative not-prose inline-block rounded-lg border border-ui shadow-lg overflow-hidden mb-3 cursor-zoom-in"
            onclick={`window.dispatchEvent(
              new CustomEvent('openLightbox', {
                detail: { index: ${index}, button: this }
              })
            )`}
          >
            <ImageWrapper
              src={img}
              alt={title}
              class="block w-full h-full non-prose aspect-4/5 shadow-lg rounded-lg object-cover group-hover:scale-105 transition-transform duration-300"
              loading="lazy"
              data-lightbox="gallery"
              data-caption={title}
            />

            <div class="absolute inset-0 flex items-center justify-center bg-black/0 group-hover:bg-black/20 transition-colors duration-300">
              <svg
                class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
            </div>
          </button>
        ))}
      </div>
    ) : (
      <div class="animate text-center py-24">
        <p class="text-lg text-content-3">
          No images found in this gallery.
        </p>
      </div>
    )}
  </Container>
  <!-- Lightbox Component -->
  <Lightbox />
</BaseLayout>

<style>
  .gallery-image-button {
    border: none;
    padding: 0;
    background: none;
  }
  
  .gallery-image-button:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
  
  /* Fix black overlay issue */
  .gallery-image-button img {
    display: block;
    width: 100%;
    height: 100%;
  }
  
  /* Ensure Picture component renders properly */
  .gallery-image-button picture {
    display: block;
    width: 100%;
    height: 100%;
  }
</style>