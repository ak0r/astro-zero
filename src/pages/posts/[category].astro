---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Container from '@/components/layout/Container.astro';
import PageHeader from '@/components/layout/PageHeader.astro';
import FilterTabs from '@/components/layout/FilterTabs.astro';
import YearGroup from '@/components/content/YearGroup.astro';
import { 
  getAllPosts, 
  sortPostsByDate, 
  getTopLevelPosts,
  getPostsByYearSorted,
  filterByCategory ,
  getCategoryCounts
} from '@/utils/getContent';
import { generateIndexSEO } from '@/utils/seo';
import SEO from '@/components/common/SEO.astro';
import { POST_CATEGORIES, siteConfig, type PostCategory } from '@/site.config';
import ContentDisplay from '@/components/content/ContentDisplay.astro';

export async function getStaticPaths() {
  return POST_CATEGORIES.map(category => ({
    params: { category },
  }));
}

const { category } = Astro.params;
const postCategory = category as PostCategory;
const categoryConfig = siteConfig.categories[postCategory];

// Get all posts for filter tabs
const allPosts = await getAllPosts();
const counts = getCategoryCounts(allPosts);
const filteredPosts = filterByCategory(allPosts, postCategory);
const sortedPosts = sortPostsByDate(filteredPosts);
const topLevelPosts = getTopLevelPosts(sortedPosts);

// Group by year
const postsByYear = await getPostsByYearSorted(topLevelPosts);
const nonEmptyYears = postsByYear.filter(([year, posts]) => posts.length > 0);

// Build filter tabs
const tabs = [
  {
    label: 'All',
    href: '/posts',
    icon: 'layout-grid',
    count: allPosts.length,
  },
  ...POST_CATEGORIES.map(cat => ({
    label: siteConfig.categories[cat].title,
    href: `/posts/${cat}`,
    icon: siteConfig.categories[cat].icon,
    iconColor: siteConfig.categories[cat].color,
    count: counts[cat] || 0,
    active: cat === postCategory,
  })),
];

// Determine display mode based on category
const displayMode = categoryConfig.view === 'grid' ? 'grid' : 'list';
const shouldGroupByYear = categoryConfig.view === 'list';

// Page title
const pageTitle = categoryConfig.title && `${categoryConfig.title}` || "";
const pageDescription = categoryConfig?.description && `${categoryConfig.description}` || "";

// SEO
const seoData = generateIndexSEO('posts', Astro.url.href, {
  customTitle: `${pageTitle}`,
  customDescription: `${pageDescription}`,
});

---

<BaseLayout>
  <SEO data={seoData} slot="seo" />
  <Container class="py-4 sm:py-8">
    <PageHeader
      title={pageTitle}
      description={pageDescription}
      breadcrumb={Astro.url.pathname}
    />
    
    <FilterTabs tabs={tabs} class="mb-8" />
    
    <ContentDisplay
      entries={sortedPosts}
      display={displayMode}
      groupByYear={shouldGroupByYear}
      showImages={categoryConfig.view === 'grid'}
      showDescription={categoryConfig.view === 'grid'}
      showTags={categoryConfig.view === 'grid'}
    />
  </Container>
</BaseLayout>