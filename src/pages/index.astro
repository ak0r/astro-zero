---
import Container from "@/components/layout/Container.astro"
import BaseLayout from "@/layouts/BaseLayout.astro"
import { generateHomeSEO } from '@/utils/seo';
import SEO from '@/components/common/SEO.astro';
import { getHomeContent } from '@/utils/page-sections';
import { getAllPosts, getTopLevelPosts, sortPostsByDate } from "@/utils/getContent";
import ContentDisplay from "@/components/content/ContentDisplay.astro";
import { getContentDir } from "@/utils/commonFunctions";
import { resolveImageFromPath } from '@/utils/images';
import { getEntry } from 'astro:content';
import { siteConfig } from '@/site.config';
import ImageWrapper from "@/components/common/ImageWrapper.astro";

// Fetch all posts and galleries
const allPosts = await getAllPosts();
const parentPosts = await getTopLevelPosts(allPosts);
const sortedPosts = await sortPostsByDate(parentPosts);

const entry = await getEntry('pages', 'home-about');

// Load optional content sections
const sections = await getHomeContent();
const { hero, intro, about, cta } = sections;

const contentDir = entry
  ? getContentDir(entry.filePath)
  : undefined;
  
const aboutImage = about ? about.data.cover ? await resolveImageFromPath(about.data.cover, {
  baseDir: contentDir,
}) : null : null;

const seoData = generateHomeSEO(Astro.url.href);

---
<BaseLayout>
  <SEO data={seoData} slot="seo" />
  <Container class="py-6 sm:py-12 flex flex-col space-y-4">

    <!-- ============================================================ -->
    <!-- HERO SECTION (Optional from home-hero.md) -->
    <!-- ============================================================ -->
    {sections.hero && (
      <section class="my-4 max-w-none">
        {sections.hero.data.title && 
          <h1 class="text-4xl font-bold mb-4">{hero.data.title}</h1>
        }
        <sections.hero.Content />
      </section>
    )}

    <!-- ============================================================ -->
    <!-- INTRO SECTION (Optional from home-intro.md) -->
    <!-- ============================================================ -->
    
    {sections.intro && (
      <section class="my-4 max-w-none">
        {sections.intro.data.title && 
          <h2 class="text-xl font-bold mb-4">{intro.data.title}</h2>
        }
        <sections.intro.Content />
      </section>
    )}

    <!-- ============================================================ -->
    <!-- ABOUT SECTION (Optional from home-about.md) -->
    <!-- ============================================================ -->
    {sections.about && (
      <section class="flex flex-col my-4 max-w-none">
        {sections.about.data.title && 
          <h2 class="text-xl font-bold mb-4">{about.data.title}</h2>
        }
        <sections.about.Content />
        {aboutImage && (
          <div class="breakout border border-ui rounded-lg">
            <ImageWrapper
              src={aboutImage}
              alt={siteConfig.author}
              class="w-full rounded-lg not-prose aspect-3/2 border border-ui shadow-lg"
              fit="cover"
            />
          </div>
        )}
      </section>
    )}
    
    <!-- ============================================================ -->
    <!-- Recent Posts -->
    <!-- ============================================================ -->

    <ContentDisplay
      title="Recent Posts"
      entries={sortedPosts.slice(0, 4)}
      display="grid"
      showImages
      class="my-4"
    />



    <!-- ============================================================ -->
    <!-- CTA SECTION (Optional from home-cta.md) -->
    <!-- ============================================================ -->
    {sections.cta && (
      <section class="my-4 max-w-none">
        {sections.cta.data.title && 
          <h2 class="text-xl font-bold mb-4">{cta.data.title}</h2>
        }
        <sections.cta.Content />
      </section>
    )}

  </Container>
</BaseLayout>