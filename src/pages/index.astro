---
import Container from "@/components/layout/Container.astro"
import BaseLayout from "@/layouts/BaseLayout.astro"
import { generateHomeSEO } from '@/utils/seo';
import SEO from '@/components/common/SEO.astro';
import { getHomeContent } from '@/utils/page-sections';
import { getAllPosts, getTopLevelPosts, sortPostsByDate, filterByCategory } from "@/utils/getContent";
import ContentDisplay from "@/components/content/ContentDisplay.astro";
import { getContentDir } from "@/utils/commonFunctions";
import { resolveImageFromPath } from '@/utils/images';
import { getEntry } from 'astro:content';
import { siteConfig } from '@/site.config';
import ImageWrapper from "@/components/common/ImageWrapper.astro";
import IconWrapper from "@/components/common/IconWrapper.astro";

// Fetch all posts and galleries
const allPosts = await getAllPosts();
const parentPosts = await getTopLevelPosts(allPosts);
const sortedPosts = await sortPostsByDate(parentPosts);

// Split by category
const travelPosts = sortPostsByDate(filterByCategory(sortedPosts, 'travel')).slice(0, 4);
const techPosts = sortPostsByDate(filterByCategory(sortedPosts, 'tech')).slice(0, 4);

const entry = await getEntry('pages', 'home-about');

// Load optional content sections
const sections = await getHomeContent();
const {  about, cta } = sections;

const contentDir = entry
  ? getContentDir(entry.filePath)
  : undefined;
  
const aboutImage = about ? about.data.cover ? await resolveImageFromPath(about.data.cover, {
  baseDir: contentDir,
}) : null : null;

const seoData = generateHomeSEO(Astro.url.href);

---
<BaseLayout>
  <SEO data={seoData} slot="seo" />
  <Container class="py-6 sm:py-12 flex flex-col space-y-4">

    <!-- ============================================================ -->
    <!-- ABOUT SECTION (Optional from home-about.md) -->
    <!-- ============================================================ -->
    {sections.about && (
      <section class="flex flex-col my-4 max-w-none">
        {sections.about.data.title && 
          <h1 class="text-2xl font-bold mb-4">{about.data.title}</h1>
        }
        <sections.about.Content />
        {aboutImage && (
          <div class="breakout border border-ui rounded-lg">
            <ImageWrapper
              src={aboutImage}
              alt={siteConfig.author}
              class="w-full rounded-lg not-prose aspect-3/2 border border-ui shadow-lg"
              fit="cover"
            />
          </div>
        )}
      </section>
    )}
    
    <!-- ============================================================ -->
    <!-- Recent Posts -->
    <!-- ============================================================ -->
    
    <!-- Travel Section (with images) -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <IconWrapper name={siteConfig.categories.travel.icon} size={24} />
          Recent {siteConfig.categories.travel.title}
        </h2>
        <a 
          href="/posts/travel" 
          class="text-sm text-content-3 hover:text-content internal-link"
        >
          View all →
        </a>
      </div>
      
      <ContentDisplay
        entries={travelPosts}
        display="grid"          
        showImages
        showDescription
        showTags
        showBadge={false}
        class="my-4"
      />
    </section>

    <!-- Tech Section (no images) -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <IconWrapper name={siteConfig.categories.tech.icon} size={24} />
          Recent {siteConfig.categories.tech.title}
        </h2>
        <a 
          href="/posts/tech" 
          class="text-sm text-content-3 hover:text-content internal-link"
        >
          View all →
        </a>
      </div>
      
      <ContentDisplay
        entries={techPosts}
        display="card"
        showImages={false}
        showDescription={true}
        showTags={true}
        showBadge={false}
      />
    </section>

    <!-- ============================================================ -->
    <!-- CTA SECTION (Optional from home-cta.md) -->
    <!-- ============================================================ -->
    {sections.cta && (
      <section class="my-4 max-w-none">
        {sections.cta.data.title && 
          <h2 class="text-xl font-bold mb-4">{cta.data.title}</h2>
        }
        <sections.cta.Content />
      </section>
    )}

  </Container>
</BaseLayout>