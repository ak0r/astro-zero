---
/**
 * PostLayout Component
 *
 * Layout for blog posts and galleries.
 * Uses _BaseContentLayout for shared structure.
 */
import { render } from "astro:content";
import type { Post } from '@/types';
import { siteConfig, type PostCategory } from '@/site.config';
import { resolveImageFromPath } from '@/utils/images';
import { generatePostSEO, generateGallerySEO } from '@/utils/seo';
import ContentLayout from './ContentLayout.astro';
import ImageWrapper from '@/components/common/ImageWrapper.astro';
import ContentNavigation from '@/components/widgets/ContentNavigation.astro';
import {
  getAllPosts,
  getAdjacentPosts,
  sortPostsByDate,
  getSeriesContext,
  isGallery
} from '@/utils/getContent';
import { formatDate, calculateReadingTime, getContentDir } from '@/utils/commonFunctions';
import IconWrapper from "@/components/common/IconWrapper.astro";
import SeriesPosts from "@/components/widgets/SeriesPosts.astro";
import PageHeader from '@/components/layout/PageHeader.astro';
import ContentGallery from "@/components/content/ContentGallery.astro";
import Lightbox from "@/components/common/Lightbox.astro";

export interface Props {
  post: Post;
}

const { post } = Astro.props;

// Check if this is a gallery
const isGalleryPost = isGallery(post);

// Generate SEO data
const seoData = isGalleryPost
  ? generateGallerySEO(post, Astro.url.href)
  : generatePostSEO(post, Astro.url.href);

// Get all posts for navigation and series
const allPosts = await getAllPosts();
const sortedPosts = sortPostsByDate(allPosts);

// Get series context
const seriesContext = getSeriesContext(allPosts, post);
const {
  isCurrentSubpost,
  isInSeries,
  seriesPosts,
  parentPost,
} = seriesContext;

// Get adjacent posts for navigation (convert null to undefined for type compatibility)
const adjacentPosts = getAdjacentPosts(sortedPosts, post.id);
const prevPost = isCurrentSubpost ? seriesContext.prevInSeries : adjacentPosts.older ?? undefined;
const nextPost = isCurrentSubpost ? seriesContext.nextInSeries : adjacentPosts.newer ?? undefined;

// Process content
const { Content } = await render(post);
const readingTime = calculateReadingTime(post.body || '');
const tags = post.data.tags;

// Process cover image
let postImage = post.data.cover;
if (Array.isArray(postImage)) {
  postImage = postImage[0];
}

const contentDir = post.filePath ? getContentDir(post.filePath) : undefined;
const coverImage = resolveImageFromPath(postImage, { baseDir: contentDir });
const coverImageAlt = post.data.coverAlt || `Featured image for post: ${post.data.title}`;

// Category config
const categoryConfig = siteConfig.categories[post.data.category as PostCategory];
const category = 'category' in post.data ? post.data.category as PostCategory : undefined;
---

<ContentLayout seo={seoData}>
  {/* Header Slot */}
  <Fragment slot="header">
    <PageHeader
      title={post.data.title}
      description={post.data.description ?? undefined}
      breadcrumb={Astro.url.pathname}
    />

    {/* Cover Image */}
    {coverImage && (
      <div class="mb-6 sm:mb-10 breakout ring ring-ui rounded-lg">
        <ImageWrapper
          src={coverImage}
          alt={coverImageAlt}
          width={600}
          height={400}
          class="w-full rounded-lg not-prose aspect-3/2 border border-ui shadow-lg"
          fit="cover"
          loading="eager"
        />
      </div>
    )}
  </Fragment>

  {/* Meta Slot */}
  <Fragment slot="meta">
    <div class="relative">
      <div class="space-y-2 sm:space-y-4">
        {/* Category Meta */}
        <div class="flex items-center gap-2 sm:gap-3">
          {category && categoryConfig && (
            <span
              class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-lg border"
              style={`background-color: ${categoryConfig.color}20; color: ${categoryConfig.color}; border-color: ${categoryConfig.color}40;`}
            >
              {categoryConfig.icon && <IconWrapper name={categoryConfig.icon} class="size-3" />}
              {categoryConfig.title}
            </span>
          )}

          {isGalleryPost && post.data.location && (
            <>
              <span>&bull;</span>
              <div class="flex items-center gap-2">
                <IconWrapper name="map-pin" size={16} />
                <span>{post.data.location}</span>
              </div>
            </>
          )}
        </div>

        {/* Common Post Meta */}
        <div class="flex flex-wrap items-center gap-2 sm:gap-3 text-sm font-mono text-content-3">
          <div class="flex items-center gap-2">
            <IconWrapper name="calendar-week" size={16} />
            <time>{formatDate(post.data.date, 'full')}</time>
          </div>

          {!isGalleryPost && readingTime && (
            <>
              <span>&bull;</span>
              <span>
                {readingTime.text && readingTime.text !== 'read0' && readingTime.text !== ''
                  ? readingTime.text
                  : '1 min read'}
              </span>
            </>
          )}

          {tags && (
            <>
              <span>&bull;</span>
              <IconWrapper name="tag" size={16} />
              {tags.map(tag => (
                <div class="not-prose flex gap-1 sm:gap-2 self-start">
                  <a
                    href={`/tags/${encodeURIComponent(tag)}`}
                    class="internal-link badge-outline"
                  >
                    #{tag}
                  </a>
                </div>
              ))}
            </>
          )}
        </div>
      </div>

      {/* Series Widget */}
      {isInSeries && seriesPosts.length > 1 && (
        <SeriesPosts
          seriesPosts={seriesPosts}
          currentPostId={post.id}
          seriesTitle={parentPost?.data.title}
          class="my-8"
        />
      )}
    </div>
  </Fragment>

  {/* Content Slot */}
  <Fragment slot="content">
    <meta data-pagefind-filter="collection[content]" content="posts" />
    <meta data-pagefind-filter="category[content]" content={post.data.category} />
    <meta data-pagefind-meta="title[content]" content={post.data.title} />
    <meta data-pagefind-sort="date[content]" content={post.data.date.toISOString()} />

    <div class="md-content" id="post-content">
      <Content />
    </div>

    {isGalleryPost && post.data.imageDir && (
      <div class="gallery-section">
        <ContentGallery gallery={post} />
      </div>
    )}
  </Fragment>

  {/* Navigation Slot */}
  <Fragment slot="navigation">
    <ContentNavigation
      prevEntry={prevPost}
      nextEntry={nextPost}
      parentEntry={isCurrentSubpost ? (parentPost ?? undefined) : undefined}
    />
    <Lightbox />
  </Fragment>
</ContentLayout>
