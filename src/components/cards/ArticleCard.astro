---
// src/components/cards/ArticleCard.astro
import type { Post } from '@/types';
import { siteConfig, type PostCategory } from '@/site.config';
import { getContentDir, isValidDate, getFormattedDate } from '@/utils/commonFunctions';
import { resolveImageFromPath } from '@/utils/images';
import BaseCard from '@/components/cards/BaseCard.astro';
import Icon from '@/components/common/IconWrapper.astro';
import Arrow from '@/components/common/AnimatedArrow.astro';
import ImageWrapper from '@/components/common/ImageWrapper.astro';

interface Props {
  post: Post;
  showImage?: boolean;
  showDescription?: boolean;
  showTags?: boolean;
  showMeta?: boolean;
  featured?: boolean;
  eager?: boolean;
}

const {
  post,
  showImage = true,
  showDescription = true,
  showTags = true,
  showMeta = true,
  featured = false,
  eager = false,
} = Astro.props;

const { title, description, date, category, tags } = post.data;
const categoryConfig = category ? siteConfig.categories[category as PostCategory] : undefined;
const isFeatured = post.data.featured || featured;

// Process image
let coverImagePath = post.data.cover;
if (Array.isArray(coverImagePath)) {
  coverImagePath = coverImagePath[0];
}

const contentDir = post.filePath ? getContentDir(post.filePath) : undefined;
const coverImage = resolveImageFromPath(coverImagePath, { baseDir: contentDir });
const coverImageAlt = post.data.coverAlt || `Featured image for: ${title}`;

const entryUrl = `/${post.collection}/${post.id}`;
const titleSize = featured ? 'text-lg' : 'text-base';
---

<BaseCard href={entryUrl} class="article-card">
  {/* Image */}
  {showImage && coverImage && (
    <Fragment slot="image">
      <div class="overflow-hidden rounded-lg">
        <ImageWrapper
          src={coverImage}
          alt={coverImageAlt}
          fit="cover"
          class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105 aspect-3/2"
          loading={eager ? 'eager' : 'lazy'}
        />
      </div>
    </Fragment>
  )}

  {/* Badges */}
  {showMeta && (isFeatured || categoryConfig) && (
    <Fragment slot="badge">
      <div class="flex flex-wrap items-center gap-2 mb-3">
        {/* Featured Badge */}
        {isFeatured && (
          <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-accent text-white rounded">
            <Icon name="star" class="size-3" />
            Featured
          </span>
        )}

        {/* Category Badge */}
        {categoryConfig && (
          <span 
            class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded border"
            style={`background-color: ${categoryConfig.color}20; color: ${categoryConfig.color}; border-color: ${categoryConfig.color}40;`}
          >
            {categoryConfig.icon && <Icon name={categoryConfig.icon} class="size-3" />}
            {categoryConfig.title}
          </span>
        )}
      </div>
    </Fragment>
  )}

  {/* Meta */}
  {showMeta && date && isValidDate(date) && (
    <Fragment slot="meta">
      <div class="flex items-center gap-2 text-xs text-content-3 mb-2">
        <time datetime={date.toISOString()}>
          {getFormattedDate(date)}
        </time>
      </div>
    </Fragment>
  )}

  {/* Title */}
  <Fragment slot="title">
    <h3
      class={`font-semibold text-content mb-2 group-hover:text-primary transition-colors line-clamp-2 leading-tight ${titleSize}`}
    >
      {title}
    </h3>
  </Fragment>

  {/* Description */}
  {showDescription && description && (
    <Fragment slot="description">
      <p class="text-sm text-content-3 line-clamp-3 leading-relaxed mb-4">
        {description}
      </p>
    </Fragment>
  )}

  {/* Tags */}
  {showTags && tags && tags.length > 0 && (
    <Fragment slot="tags">
      <div class="flex flex-wrap gap-2 mb-4">
        {tags.slice(0, 3).map((tag) => (
          <span class="badge">#{tag}</span>
        ))}
        {tags.length > 3 && (
          <span class="text-xs text-content-3">+{tags.length - 3}</span>
        )}
      </div>
    </Fragment>
  )}

  {/* Footer */}
  <div class="pt-4 border-t border-ui flex flex-row content-center justify-between">
    <span class="text-sm text-content-3">Read more</span>
    <Arrow direction="right" size="5" position="relative" class="text-content-3" />
  </div>
</BaseCard>