---
/**
 * ArticleCard Component
 *
 * Card component for blog posts and galleries.
 * Composed from reusable card sub-components.
 */
import type { Post } from '@/types';
import type { PostCategory } from '@/site.config';
import { getContentDir } from '@/utils/commonFunctions';
import { resolveImageFromPath } from '@/utils/images';
import BaseCard from '@/components/cards/BaseCard.astro';
import CardImage from '@/components/cards/CardImage.astro';
import CardBadges from '@/components/cards/CardBadges.astro';
import CardMeta from '@/components/cards/CardMeta.astro';
import CardFooter from '@/components/cards/CardFooter.astro';

interface Props {
  post: Post;
  showImage?: boolean;
  showDescription?: boolean;
  showTags?: boolean;
  showBadge?: boolean;
  showMeta?: boolean;
  featured?: boolean;
  eager?: boolean;
}

const {
  post,
  showImage = true,
  showDescription = true,
  showTags = true,
  showBadge = true,
  showMeta = true,
  featured = false,
  eager = false,
} = Astro.props;

const { title, description, date, category, tags } = post.data;
const isFeatured = post.data.featured || featured;

// Process image
let coverImagePath = post.data.cover;
if (Array.isArray(coverImagePath)) {
  coverImagePath = coverImagePath[0];
}

const contentDir = post.filePath ? getContentDir(post.filePath) : undefined;
const coverImage = resolveImageFromPath(coverImagePath, { baseDir: contentDir });
const coverImageAlt = post.data.coverAlt || `Featured image for: ${title}`;

const entryUrl = `/${post.collection}/${post.id}`;
const titleSize = featured ? 'text-lg' : 'text-base';

// Determine aspect ratio based on category
const aspectRatio = category === 'gallery' ? '4:5' : '3:2';

// Footer label based on category
const footerLabel = category === 'gallery' ? 'View gallery' : 'Read more';
---

<BaseCard href={entryUrl} class="article-card">
  {/* Image */}
  {showImage && coverImage && (
    <Fragment slot="image">
      <CardImage
        src={coverImage}
        alt={coverImageAlt}
        aspectRatio={aspectRatio}
        eager={eager}
      />
    </Fragment>
  )}

  {/* Badges */}
  {showBadge && (
    <Fragment slot="badge">
      <CardBadges
        featured={isFeatured}
        category={category as PostCategory}
      />
    </Fragment>
  )}

  {/* Meta */}
  {showMeta && (
    <Fragment slot="meta">
      <CardMeta
        date={date}
        location={post.data.location}
      />
    </Fragment>
  )}

  {/* Title */}
  <Fragment slot="title">
    <h3
      class={`font-semibold text-content mb-2 group-hover:text-primary transition-colors line-clamp-2 leading-tight ${titleSize}`}
    >
      {title}
    </h3>
  </Fragment>

  {/* Description */}
  {showDescription && description && (
    <Fragment slot="description">
      <p class="text-sm text-content-3 line-clamp-3 leading-relaxed mb-4">
        {description}
      </p>
    </Fragment>
  )}

  {/* Tags */}
  {showTags && tags && tags.length > 0 && (
    <Fragment slot="tags">
      <div class="flex flex-wrap gap-2 mb-4">
        {tags.slice(0, 3).map((tag) => (
          <span class="badge">#{tag}</span>
        ))}
        {tags.length > 3 && (
          <span class="text-xs text-content-3">+{tags.length - 3}</span>
        )}
      </div>
    </Fragment>
  )}

  {/* Footer */}
  <CardFooter label={footerLabel} />
</BaseCard>
