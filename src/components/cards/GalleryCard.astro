---
// src/components/cards/GalleryCard.astro
import type { Post } from '@/types';
import { getContentDir, isValidDate, getFormattedDate } from '@/utils/commonFunctions';
import { resolveImageFromPath } from '@/utils/images';
import BaseCard from './BaseCard.astro';
import Icon from '@/components/common/IconWrapper.astro';
import Arrow from '@/components/common/AnimatedArrow.astro';
import ImageWrapper from '@/components/common/ImageWrapper.astro';

interface Props {
  gallery: Post;
  showDescription?: boolean;
  showMeta?: boolean;
  eager?: boolean;
}

const {
  gallery,
  showDescription = true,
  showMeta = true,
  eager = false,
} = Astro.props;

const { title, description, date, location } = gallery.data;

// Process image
let coverImagePath = gallery.data.cover;
if (Array.isArray(coverImagePath)) {
  coverImagePath = coverImagePath[0];
}

const contentDir = gallery.filePath ? getContentDir(gallery.filePath) : undefined;
const coverImage = resolveImageFromPath(coverImagePath, { baseDir: contentDir });
const coverImageAlt = gallery.data.coverAlt || `Gallery: ${title}`;

const entryUrl = `/${gallery.collection}/${gallery.id}`;
---

<BaseCard href={entryUrl}>
  {/* Image - 4:5 aspect for galleries */}
  {coverImage && (
    <Fragment slot="image">
      <div class="overflow-hidden rounded-lg">
        <ImageWrapper
          src={coverImage}
          alt={coverImageAlt}
          fit="cover"
          class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105 aspect-4/5"
          loading={eager ? 'eager' : 'lazy'}
        />
      </div>
    </Fragment>
  )}

  {/* Meta */}
  {showMeta && (date || location) && (
    <Fragment slot="meta">
      <div class="flex items-center gap-2 text-xs text-content-3 mb-2">
        {date && isValidDate(date) && (
          <time datetime={date.toISOString()}>
            {getFormattedDate(date)}
          </time>
        )}
        
        {location && (
          <>
            <span>â€¢</span>
            <span class="flex items-center gap-1">
              <Icon name="map-pin" size={12} />
              {location}
            </span>
          </>
        )}
      </div>
    </Fragment>
  )}

  {/* Title */}
  <Fragment slot="title">
    <h3 class="font-semibold text-content mb-2 group-hover:text-primary transition-colors line-clamp-2 leading-tight text-base">
      {title}
    </h3>
  </Fragment>

  {/* Description */}
  {showDescription && description && (
    <Fragment slot="description">
      <p class="text-sm text-content-3 line-clamp-3 leading-relaxed mb-4">
        {description}
      </p>
    </Fragment>
  )}

  {/* Footer */}
  <div class="pt-4 border-t border-ui flex flex-row content-center justify-between">
    <span class="text-sm text-content-3">View gallery</span>
    <Arrow direction="right" size="5" position="relative" class="text-content-3" />
  </div>
</BaseCard>