---
// src/components/cards/ProjectCard.astro
import type { Project } from '@/types';
import { getContentDir, isValidDate, getFormattedDate } from '@/utils/commonFunctions';
import { resolveImageFromPath } from '@/utils/images';
import BaseCard from './BaseCard.astro';
import Icon from '@/components/common/IconWrapper.astro';
import Arrow from '@/components/common/AnimatedArrow.astro';
import ImageWrapper from '@/components/common/ImageWrapper.astro';

interface Props {
  project: Project;
  showImage?: boolean;
  showDescription?: boolean;
  showTags?: boolean;
  showMeta?: boolean;
  eager?: boolean;
}

const {
  project,
  showImage = true,
  showDescription = true,
  showTags = true,
  showMeta = true,
  eager = false,
} = Astro.props;

const { title, description, date, status, version, tags } = project.data;

// Process image
let coverImagePath = project.data.cover;
if (Array.isArray(coverImagePath)) {
  coverImagePath = coverImagePath[0];
}

const contentDir = project.filePath ? getContentDir(project.filePath) : undefined;
const coverImage = resolveImageFromPath(coverImagePath, { baseDir: contentDir });
const coverImageAlt = project.data.coverAlt || `Project: ${title}`;

const entryUrl = `/${project.collection}/${project.id}`;
---

<BaseCard href={entryUrl}>
  {/* Image */}
  {showImage && coverImage && (
    <Fragment slot="image">
      <div class="overflow-hidden rounded-lg">
        <ImageWrapper
          src={coverImage}
          alt={coverImageAlt}
          fit="cover"
          class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105 aspect-3/2"
          loading={eager ? 'eager' : 'lazy'}
        />
      </div>
    </Fragment>
  )}

  {/* Badges */}
  {showMeta && (status || version) && (
    <Fragment slot="badge">
      <div class="flex flex-wrap items-center gap-2 mb-3">
        {/* Status Badge */}
        {status && (
          <span class="text-xs text-content-3 bg-surface-2 px-2 py-1 rounded border border-ui capitalize">
            {status}
          </span>
        )}

        {/* Version Badge */}
        {version && (
          <span class="text-xs text-content-3 font-mono bg-surface-2 px-2 py-1 rounded">
            v{version}
          </span>
        )}
      </div>
    </Fragment>
  )}

  {/* Meta */}
  {showMeta && date && isValidDate(date) && (
    <Fragment slot="meta">
      <div class="flex items-center gap-2 text-xs text-content-3 mb-2">
        <time datetime={date.toISOString()}>
          {getFormattedDate(date)}
        </time>
      </div>
    </Fragment>
  )}

  {/* Title */}
  <Fragment slot="title">
    <h3 class="font-semibold text-content mb-2 group-hover:text-primary transition-colors line-clamp-2 leading-tight text-base">
      {title}
    </h3>
  </Fragment>

  {/* Description */}
  {showDescription && description && (
    <Fragment slot="description">
      <p class="text-sm text-content-3 line-clamp-3 leading-relaxed mb-4">
        {description}
      </p>
    </Fragment>
  )}

  {/* Tags */}
  {showTags && tags && tags.length > 0 && (
    <Fragment slot="tags">
      <div class="flex flex-wrap gap-2 mb-4">
        {tags.slice(0, 3).map((tag) => (
          <span class="badge">#{tag}</span>
        ))}
        {tags.length > 3 && (
          <span class="text-xs text-content-3">+{tags.length - 3}</span>
        )}
      </div>
    </Fragment>
  )}

  {/* Footer */}
  <div class="pt-4 border-t border-ui flex flex-row content-center justify-between">
    <span class="text-sm text-content-3">Read details</span>
    <Arrow direction="right" size="5" position="relative" class="text-content-3" />
  </div>
</BaseCard>