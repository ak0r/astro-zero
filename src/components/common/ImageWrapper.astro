---
import { Picture } from "astro:assets";
import type { ImageMetadata } from "astro";

type ImageSource = ImageMetadata | string;

type Props = {
  src: ImageSource;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  loading?: "lazy" | "eager";
  layout?: "constrained" | "full-width" | "fixed" | "none";
  fit?: "contain" | "cover" | "fill" | "none" | "scale-down";
  position?: string;
  caption?: string;
};

const {
  src,
  alt,
  width = 900,
  height = 600,
  class: className,
  loading = "lazy",
  layout = "constrained",
  fit = "cover",
  position = "center",
  caption,
  ...rest
} = Astro.props as Props;

const isAstroImage = (src: unknown): src is ImageMetadata => {
  return typeof src === "object" && src !== null && "src" in src;
};
---

{src && (
  <figure class="not-prose">
    {isAstroImage(src) ? (
      <Picture
        src={src}
        alt={alt}
        width={width}
        height={height}
        loading={loading}
        decoding="async"
        formats={["webp", "avif"]}
        class={className}
        layout={layout}
        fit={fit}
        position={position}
        {...rest}
      />
    ) : (
      <img
        src={src}
        alt={alt}
        loading={loading}
        class={className}
        {...rest}
      />
    )}

    {caption && (
      <figcaption class="mt-2 text-sm text-center text-content-3 leading-snug">
        {caption}
      </figcaption>
    )}
  </figure>
)}
