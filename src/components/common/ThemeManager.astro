---
// ThemeManager handles initial load and system preference detection
---
<script is:inline>
  ;(function loadTheme() {
    const pageDefaultTheme = document.documentElement.getAttribute('data-theme')
    const pageDarkTheme = document.documentElement.getAttribute('data-dark-theme')
    const pageLightTheme = document.documentElement.getAttribute('data-light-theme')
    const pageThemeHash = document.documentElement.getAttribute('data-theme-hash')
    
    if (!pageDefaultTheme || !pageDarkTheme || !pageLightTheme || !pageThemeHash) {
      throw new Error('Theme attributes are required.')
    }

    const getStoredTheme = () => localStorage.getItem('data-theme')
    const storedTheme = getStoredTheme()
    const storedThemeHash = localStorage.getItem('data-theme-hash')
    const themeHashMatches = storedThemeHash === pageThemeHash

    if (!storedTheme || !storedThemeHash || !themeHashMatches) {
      // First time loading
      localStorage.setItem('data-theme', pageDefaultTheme)
      localStorage.setItem('data-theme-hash', pageThemeHash)
    }

    // Helper to apply system preference
    const applySystemTheme = () => {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
      const systemTheme = prefersDark ? pageDarkTheme : pageLightTheme
      document.documentElement.setAttribute('data-theme', systemTheme)
      return systemTheme
    }

    const currentStoredTheme = getStoredTheme()

    // Apply theme based on stored preference
    if (currentStoredTheme === 'auto' || currentStoredTheme === 'system') {
      applySystemTheme()
      
      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (getStoredTheme() === 'auto' || getStoredTheme() === 'system') {
          applySystemTheme()
        }
      })
    } else if (currentStoredTheme && currentStoredTheme !== pageDefaultTheme) {
      document.documentElement.setAttribute('data-theme', currentStoredTheme)
    } else if (pageDefaultTheme === 'auto' || pageDefaultTheme === 'system') {
      applySystemTheme()
    }
  })()
</script>