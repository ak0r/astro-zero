---
import type { Post, Project } from '@/types';
import { siteConfig, type PostCategory } from '@/site.config';
import Icon from '@/components/common/IconWrapper.astro';
import Arrow from '@/components/common/AnimatedArrow.astro';
import ImageWrapper from '@/components/common/ImageWrapper.astro';
import { isValidDate, getFormattedDate, getContentDir } from '@/utils/commonFunctions';
import { resolveImageFromPath } from '@/utils/images';

interface Props {
  entry: Post | Project;
  showImages?: boolean;
  showDescription?: boolean;
  showTags?: boolean;
  showMeta?: boolean;
  featured?: boolean;
  context?: 'featured' | 'recent' | 'posts' | 'tags' | 'docs';
  eager?: boolean;
}

const {
  entry,
  showImages = true,
  showDescription = true,
  showTags = true,
  showMeta = true,
  featured = false,
  context = 'posts',
  eager = false,
} = Astro.props;

const { title, description, date } = entry.data;
const collection = entry.collection;

// Get category for posts
const category = 'category' in entry.data ? entry.data.category as PostCategory : undefined;
const categoryConfig = category ? siteConfig.categories[category] : undefined;

// Process image
let entryImage = entry.data.cover;
if (Array.isArray(entryImage)) {
  entryImage = entryImage[0];
}

const contentDir = entry.filePath ? getContentDir(entry.filePath) : undefined;
const coverImage = resolveImageFromPath(entryImage, { baseDir: contentDir });
const coverImageAlt = entry.data.coverAlt || `Featured image for: ${title}`;

// Type-specific data
const tags = 'tags' in entry.data ? entry.data.tags : null;
const location = 'location' in entry.data ? entry.data.location : null;
const isFeatured = 'featured' in entry.data ? entry.data.featured : false;
const version = 'version' in entry.data ? entry.data.version : null;
const status = 'status' in entry.data ? entry.data.status : null;

// Determine if we should show the cover image
const shouldShowCoverImage = showImages && coverImage;

// Card styling
const cardClass = featured ? 'featured-card' : 'content-card';
const titleSize = featured ? 'text-lg' : 'text-base';

// Build URL using slug
const entryUrl = `/${entry.collection}/${entry.id}`;
// const coverAspect = category === 'gallery' ? 'aspect-4/5' : 'aspect-3/2'
const coverAspect = 'aspect-3/2';
---

<div
  class={`group ${cardClass} relative blog-card h-full flex flex-col`}
  data-category={category}
>
  <a href={entryUrl} class="block h-full flex-col">
    {/* Cover Image */}
    {shouldShowCoverImage && (
      <div
        class="overflow-hidden rounded-lg"
      >
        <ImageWrapper
          src={coverImage}
          alt={coverImageAlt}
          fit="cover"
          class={`w-full h-full object-cover transition-transform duration-300 group-hover:scale-105 ${coverAspect}`}
          loading={eager ? 'eager' : 'lazy'}
        />
      </div>
    )}

    {/* Content */}
    <div class="p-4 sm:p-5 grow flex flex-col">
      {/* Badges Row */}
      {showMeta && (isFeatured || version || status || category) && (
        <div class="flex flex-wrap items-center gap-2 mb-3">
          {/* Featured Badge */}
          {isFeatured && (
            <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-accent text-white rounded">
              <Icon name="star" class="size-3" />
              Featured
            </span>
          )}

          {/* Category Badge */}
          {category && categoryConfig && (
            <span 
              class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded border"
              style={`background-color: ${categoryConfig.color}20; color: ${categoryConfig.color}; border-color: ${categoryConfig.color}40;`}
            >
              {categoryConfig.icon && <Icon name={categoryConfig.icon} class="size-3" />}
              {categoryConfig.title}
            </span>
          )}

          {/* Version Badge (Docs) */}
          {version && (
            <span class="text-xs text-content-3 font-mono bg-surface-2 px-2 py-1 rounded">
              v{version}
            </span>
          )}

          {/* Status Badge (Projects) */}
          {status && (
            <span class="text-xs text-content-3 bg-surface-2 px-2 py-1 rounded border border-ui capitalize">
              {status}
            </span>
          )}
        </div>
      )}

      {/* Meta Info */}
      <div class="flex items-center gap-2 text-xs text-content-3 mb-2">
        {showMeta && date && isValidDate(date) && (
          <time datetime={date.toISOString()}>{getFormattedDate(date)}</time>
        )}
        
        {/* Location for galleries */}
        {location && (
          <>
            <span>â€¢</span>
            <span class="flex items-center gap-1">
              <Icon name="map-pin" size={12} />
              {location}
            </span>
          </>
        )}
      </div>

      {/* Title */}
      <h3
        class={`font-semibold text-content mb-2 group-hover:text-primary transition-colors line-clamp-2 leading-tight ${titleSize}`}
      >
        {title}
      </h3>

      {/* Description */}
      {showDescription && description && (
        <p class="text-sm text-content-3 line-clamp-3 leading-relaxed mb-4">
          {description}
        </p>
      )}

      {/* Tags */}
      {showTags && tags && tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-4">
          {tags.slice(0, 3).map((tag) => (
            <span class="badge">
              #{tag}
            </span>
          ))}
          {tags.length > 3 && (
            <span class="text-xs text-content-3">+{tags.length - 3}</span>
          )}
        </div>
      )}

      {/* Footer with Arrow */}
      <div class="mt-auto pt-4 border-t border-ui flex flex-row content-center justify-between">
        <span class="text-sm text-content-3">
          Read {collection === 'projects' ? 'details' : 'more'}
        </span>
        <Arrow direction="right" size="5" position="relative" class="text-content-3" />
        
      </div>
    </div>
  </a>
</div>