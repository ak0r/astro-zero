---
import type { Gallery } from '@/types';
import { formatDate } from '@/utils/commonFunctions';
import IconWrapper from '@/components/common/IconWrapper.astro';
import { getGalleryCoverImage, getGalleryImageCount, extractGalleryDir } from '@/utils/getGallery';
import ImageWrapper from '@/components/common/ImageWrapper.astro';
interface Props {
  gallery: Gallery;
}

const { gallery } = Astro.props;
const { title, date, location, cover, coverAlt, featured } = gallery.data;

const galleryDir = extractGalleryDir(gallery.filePath);

// Get cover image and image count
const coverImage = await getGalleryCoverImage(gallery, galleryDir);
const imageCount = await getGalleryImageCount(galleryDir, gallery.data.imageDir);

// Remove .md/.mdx extension
const slug = gallery.id.replace(/\.(md|mdx)$/, '');
---

<a 
  href={`/galleries/${slug}`}
  class="gallery-card group block not-prose"
>
  <!-- Cover Image -->
  <div class="relative img-container not-prose inline-block rounded-lg border border-ui shadow-lg overflow-hidden mb-3">
    {coverImage ? (
      <div class="">
        <ImageWrapper
          src={coverImage}
          alt={title}
          class="block w-full h-full aspect-4/5 transition-all group-hover:scale-105 duration-300"
          fit="cover"
          layout="constrained"
          loading='eager'
        />
      </div>
    ) : (
      <div class="w-full h-full bg-surface-muted flex items-center justify-center">
        <IconWrapper name="photo" size={48} class="text-content-3" />
      </div>
    )}
    
    <!-- Gradient overlay at bottom -->
    <div class="absolute left-0 bottom-0 right-0 top-2/3 bg-linear-to-b from-transparent to-content z-10"></div>
    <!-- Location badge (bottom-right) -->
    {location && (
      <div class="absolute z-20 left-0 bottom-0 right-0 px-4 py-6 text-sm text-surface font-mono flex items-center justify-end">
        <div class="flex items-center gap-2"> 
          <IconWrapper name="map-pin" size={14} class="text-primary shrink-0" />
          <span class="text-sm font-medium drop-shadow-md">{location}</span>
        </div>
      </div>
    )}
    <!-- Featured indicator (top-left) -->
    {featured && (
      <div class="absolute top-3 left-3">
        <IconWrapper name="star" size={16} class="text-primary drop-shadow-md" />
      </div>
    )}
  </div>
  <div>
    <!-- Title -->
    <h3 class="text-lg font-semibold text-content mb-4 group-hover:underline">
      {title}
    </h3>
  </div>
  <!-- Metadata below image -->
  <div class="flex items-center justify-between text-sm">
    <time 
      datetime={date.toISOString()}
      class="text-content-3 font-mono"
    >
      {formatDate(date, "full")}
    </time>
    <span class="text-content-3 font-mono">{imageCount} images</span>
  </div>
</a>