---
import { siteConfig } from '@/site.config';
import Container from '@/components/layout/Container.astro';
import Icon from '@/components/common/IconWrapper.astro';
import Navigation from '@/components/layout/Navigation.astro';
import ThemeToggle from '@/components/widgets/ThemeToggle.astro';

const showProfilePicture = siteConfig.profilePicture.enabled && siteConfig.profilePicture.placement === 'header';
const profilePicture = siteConfig.profilePicture;

const getHeaderProfilePictureClasses = (style: string) => {
  switch (style) {
    case 'circle': return 'w-8 h-8 rounded-full object-cover border-2 border-ui';
    case 'square': return 'w-8 h-8 rounded-lg object-cover border-2 border-ui';
    default: return 'h-8 object-contain';
  }
};
---
<header
  id="main-header"
  class="sticky top-0 z-50 bg-surface/50 backdrop-blur-lg"
>
  <Container>
    <div class="not-prose flex items-center h-24">

      <!-- LEFT: Logo -->
      <div class="flex items-center flex-shrink-0">
        <a href="/" class="hover:opacity-75 transition-opacity">
          {showProfilePicture ? (
            <img
              src={profilePicture.image}
              alt={profilePicture.alt}
              class={getHeaderProfilePictureClasses(profilePicture.style)}
            />
          ) : (
            <span class="font-semibold text-2xl">
              {siteConfig.title}
            </span>
          )}
        </a>
      </div>

      <!-- CENTER: Desktop Navigation -->
      <div class="hidden md:flex flex-1 justify-center">
        <Navigation />
      </div>

      <!-- RIGHT: Actions -->
      <div class="flex items-center ml-auto gap-2 shrink-0">

        <!-- Theme toggle (always visible) -->
        <ThemeToggle />

        <!-- Command palette -->
        {siteConfig.commandPaletteConfig.enabled && (
          <button
            id="command-palette-trigger"
            class="btn-ghost flex items-center sm:gap-2 text-content-3"
            aria-label="Open command palette"
            onclick="window.dispatchEvent(new CustomEvent('command-palette:open', { detail: { mode: 'command' } }))"
          >
            <Icon name="command" size={16} class="shrink-0" />
            <kbd class="hidden sm:inline text-sm font-medium">
              K
            </kbd>
          </button>
        )}

        <!-- Mobile menu -->
        <button
          id="mobile-menu-toggle"
          class="md:hidden btn"
          aria-label="Toggle navigation"
          aria-expanded="false"
        >
          <span id="menu-icon">
            <Icon name="menu" size={16} />
          </span>
          <span id="close-icon" class="hidden">
            <Icon name="x" size={16} />
          </span>
        </button>

      </div>
    </div>
  </Container>
</header>

<nav
  id="mobile-drawer"
  class="
    fixed inset-0 z-40
    bg-surface
    p-6 pt-24
    translate-x-full
    transition-transform duration-300 ease-in-out
    md:hidden
  "
>
  <Navigation />
</nav>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('mobile-menu-toggle');
    const drawer = document.getElementById('mobile-drawer');
    const menuIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');

    toggle?.addEventListener('click', () => {
      const isOpen = !drawer.classList.contains('translate-x-full');

      drawer.classList.toggle('translate-x-full', isOpen);
      menuIcon.classList.toggle('hidden', !isOpen);
      closeIcon.classList.toggle('hidden', isOpen);
      toggle.setAttribute('aria-expanded', String(!isOpen));
    });

    drawer?.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        drawer.classList.add('translate-x-full');
        menuIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        toggle.setAttribute('aria-expanded', 'false');
      });
    });

    document.addEventListener('click', (e) => {
      const target = e.target;
      if (
        !target.closest('#mobile-drawer') &&
        !target.closest('#mobile-menu-toggle')
      ) {
        drawer.classList.add('translate-x-full');
        menuIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });
  });
</script>
