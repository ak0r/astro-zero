---
import { siteConfig } from '@/site.config';
import Container from '@/components/layout/Container.astro';
import Icon from '@/components/common/IconWrapper.astro';

const showProfilePicture = siteConfig.profilePicture.enabled && siteConfig.profilePicture.placement === 'header';
const profilePicture = siteConfig.profilePicture;

const getHeaderProfilePictureClasses = (style: string) => {
  switch (style) {
    case 'circle': return 'w-8 h-8 rounded-full object-cover border-2 border-ui';
    case 'square': return 'w-8 h-8 rounded-lg object-cover border-2 border-ui';
    default: return 'h-8 object-contain';
  }
};

const currentPath = Astro.url.pathname;
---

<header id="main-header">
  <Container>
    <div class="flex items-center justify-between h-24">
      
      <!-- Logo / Site Title / Profile Picture -->
      <a href="/" class="hover:opacity-75 transition-opacity">
        {showProfilePicture ? (
          <img
            src={profilePicture.image}
            alt={profilePicture.alt}
            class={getHeaderProfilePictureClasses(profilePicture.style)}
          />
        ) : (
          <span class="font-semibold text-2xl text-content-1">
            {siteConfig.title}
          </span>
        )}
      </a>

      <!-- Mobile menu toggle -->
      <button
        id="mobile-menu-toggle"
        class="md:hidden p-2 text-content-1 hover:bg-ui rounded-lg transition-colors z-50"
        aria-label="Toggle navigation"
        aria-expanded="false"
      >
        <Icon name="menu" size={20} class="menu-icon" />
        <Icon name="x" size={20} class="close-icon hidden" />
      </button>

      <!-- Navigation (shared between desktop and mobile) -->
      <nav 
        id="main-nav"
        class="
          fixed inset-0 z-40 bg-background/95 backdrop-blur-lg p-6
          md:static md:bg-transparent md:backdrop-blur-none md:p-0
          translate-x-full md:translate-x-0
          transition-transform duration-300 ease-in-out
        "
      >
        <ul class="
          flex flex-col md:flex-row 
          gap-6 md:gap-6 
          text-lg md:text-sm 
          font-mono 
          pt-24 md:pt-0
        ">
          {siteConfig.navigation.pages.map(page => {
            const isActive = currentPath === page.url || currentPath.startsWith(page.url);
            return (
              <li>
                <a 
                  href={page.url}
                  class:list={[
                    'transition-colors hover:text-primary',
                    isActive ? 'text-primary' : 'text-content-2'
                  ]}
                  target={page.url.startsWith('http') ? '_blank' : undefined}
                >
                  /{page.title.toLowerCase()}
                  {page.url.startsWith('http') && (
                    <Icon name="external-link" size={12} class="inline ml-1" />
                  )}
                </a>
              </li>
            );
          })}
        </ul>
      </nav>

    </div>
  </Container>
</header>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const menuToggle = document.getElementById('mobile-menu-toggle');
    const nav = document.getElementById('main-nav');
    const menuIcon = menuToggle?.querySelector('.menu-icon');
    const closeIcon = menuToggle?.querySelector('.close-icon');

    menuToggle?.addEventListener('click', () => {
      const isOpen = !nav?.classList.contains('translate-x-full');
      
      if (isOpen) {
        // Close menu
        nav?.classList.add('translate-x-full');
        menuIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        menuToggle?.setAttribute('aria-expanded', 'false');
      } else {
        // Open menu
        nav?.classList.remove('translate-x-full');
        menuIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');
        menuToggle?.setAttribute('aria-expanded', 'true');
      }
    });

    // Close menu when clicking nav links
    nav?.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        nav.classList.add('translate-x-full');
        menuIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        menuToggle?.setAttribute('aria-expanded', 'false');
      });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest('#main-nav') && !target.closest('#mobile-menu-toggle')) {
        if (nav && !nav.classList.contains('translate-x-full')) {
          nav.classList.add('translate-x-full');
          menuIcon?.classList.remove('hidden');
          closeIcon?.classList.add('hidden');
          menuToggle?.setAttribute('aria-expanded', 'false');
        }
      }
    });

    // Header shadow on scroll
    const header = document.getElementById('main-header');
    let isScrolled = false;
    
    const updateShadow = () => {
      const shouldHaveShadow = window.scrollY > 0;
      if (shouldHaveShadow !== isScrolled) {
        isScrolled = shouldHaveShadow;
        header?.classList.toggle('shadow-sm', shouldHaveShadow);
      }
    };

    updateShadow();
    window.addEventListener('scroll', updateShadow, { passive: true });
  });
</script>