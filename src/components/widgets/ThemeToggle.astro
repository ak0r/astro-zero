---
import Icon from '@/components/common/IconWrapper.astro';

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<button
  id="theme-toggle"
  class={`flex items-center justify-center btn-icon h-10 text-sm ${className}`}
  aria-label="Toggle theme"
  type="button"
>
  <span class="light-icon" data-theme-icon="light">
    <Icon name="sun" size={16} class="shrink-0" />
  </span>
  <span class="dark-icon" data-theme-icon="dark">
    <Icon name="moon" size={16} class="shrink-0" />
  </span>
  <span class="auto-icon" data-theme-icon="auto">
    <Icon name="brightness" size={16} class="shrink-0" />
  </span>
</button>

<script>
  function initThemeToggle() {
    const button = document.getElementById('theme-toggle');
    if (!button) return;

    const icons = {
      light: button.querySelector('[data-theme-icon="light"]') as HTMLElement,
      dark: button.querySelector('[data-theme-icon="dark"]') as HTMLElement,
      auto: button.querySelector('[data-theme-icon="auto"]') as HTMLElement,
    };
    
    const pageDarkTheme = document.documentElement.getAttribute('data-dark-theme') || 'dark';
    const pageLightTheme = document.documentElement.getAttribute('data-light-theme') || 'light';

    // Theme cycle order: light → dark → auto → light
    const themeOrder = ['light', 'dark', 'auto'] as const;
    type ThemeMode = typeof themeOrder[number];

    const getStoredThemeMode = (): ThemeMode => {
      const stored = localStorage.getItem('data-theme');
      if (stored === 'auto' || stored === 'system') return 'auto';
      if (stored === pageDarkTheme) return 'dark';
      return 'light';
    };

    const applySystemTheme = () => {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      return prefersDark ? pageDarkTheme : pageLightTheme;
    };

    const updateIcon = () => {
      const mode = getStoredThemeMode();
      
      // Hide all icons
      Object.values(icons).forEach(icon => {
        if (icon) icon.style.display = 'none';
      });
      
      // Show appropriate icon
      if (mode === 'auto') {
        if (icons.auto) icons.auto.style.display = 'block';
      } else if (mode === 'dark') {
        if (icons.dark) icons.dark.style.display = 'block';
      } else {
        if (icons.light) icons.light.style.display = 'block';
      }
    };

    const setTheme = (mode: ThemeMode) => {
      if (mode === 'auto') {
        localStorage.setItem('data-theme', 'auto');
        const systemTheme = applySystemTheme();
        document.documentElement.setAttribute('data-theme', systemTheme);
      } else if (mode === 'dark') {
        localStorage.setItem('data-theme', pageDarkTheme);
        document.documentElement.setAttribute('data-theme', pageDarkTheme);
      } else {
        localStorage.setItem('data-theme', pageLightTheme);
        document.documentElement.setAttribute('data-theme', pageLightTheme);
      }
      updateIcon();
    };

    const cycleTheme = () => {
      const currentMode = getStoredThemeMode();
      const currentIndex = themeOrder.indexOf(currentMode);
      const nextIndex = (currentIndex + 1) % themeOrder.length;
      const nextMode = themeOrder[nextIndex];
      
      setTheme(nextMode);
    };

    // Initialize icon state
    updateIcon();

    // Add click handler
    button.addEventListener('click', cycleTheme);

    // Watch for theme changes from other sources
    const observer = new MutationObserver(() => {
      updateIcon();
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme']
    });

    // Listen for system theme changes when in auto mode
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (getStoredThemeMode() === 'auto') {
        const systemTheme = applySystemTheme();
        document.documentElement.setAttribute('data-theme', systemTheme);
      }
    });
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initThemeToggle);
  } else {
    initThemeToggle();
  }

  // Re-run on Astro page transitions
  document.addEventListener('astro:after-swap', initThemeToggle);
</script>

<style>
  /* Hide all icons initially */
  [data-theme-icon] {
    display: none;
  }
</style>